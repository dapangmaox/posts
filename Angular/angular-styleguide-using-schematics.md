# 使用原理图给你的 Angular 项目添加代码规范

我们在使用 Angular CLI 创建项目时，是不包含任何代码规范相关的配置的，相信前端小伙伴们都知道项目中统一的代码规范有多重要。我之前有一篇文章介绍了怎样在 Angular 项目中配置 ESLint 和 Prettier，并使用 Husky 和 lint-staged 制定提交规范：[使用 ESLint 和 Prettier 配置 Angular 项目](https://juejin.cn/post/7068967298953904159)。个人感觉配置起来还是有点麻烦的，而且作为一名专（tou）业（lan）的程序员，肯定不希望每次创建新项目时都挨个依赖安装＆配置一遍，对吧～

那怎么办呢？当然是用原理图呀！有了原理图，我们只需要一个命令，就可以把所有依赖和相关的配置文件都添加到我们的项目中，岂不是美滋滋～

本篇文章，我们会从零开始，一步步构建一个功能完整的原理图。希望通过本篇文章，让你既能够了解原理图的工作原埋，也能创建属于自己的代码规范！

## 什么是原理图

先来了解一下什么是原理图（Schematics）。

Angular 原理图是一个基于模板的支持复杂逻辑的代码生成器。它是一组通过生成代码或修改代码来转换软件项目的指令。原理图会打包成集合（collection） 并用 npm 安装。

原理图的集合可以作为一个强大的工具，以创建、修改和维护任何软件项目，特别是当要自定义，Angular 项目以满足你自己组织的特定需求时。比如，你可以借助原理图来用预定义的模板或布局生成常用的 UI 模式或特定的组件。也可以用原理图来强制执行架构规则和约定，让你的项目保持一致性和互操作性。

原理图是 Angular 生态中很重要的部分，相信用过 Angular 的同学都用过 `ng generate` 或者 `ng-add` 命令吧，这个命今运行的就是原理图哦～

### 原理图中的概念

原理图提供了一些 public API 用来表达基本概念，先理解这些概念，对我们编写原理图是很有帮助的。

#### Tree

虚拟文件系统用 `Tree` 表示。`Tree` 中的数据包含**当前状态**和一个**暂存区**。当前状态包含了已经存在的文件集合，暂存区包含了要应用到当前状态的一系列改动。

之所以这样设计，是因为在应用程序中操作代码是有风险的。比如。创建一个已经存在的文件会出错，如果出现这种情况，应该也放弃其他的更改，所以有了暂存区的存在。

在修改进行的过程中，我们并没有真正改变当前文件，而是把修改添加到了暂存区。在原理图运行时，只有当这些所有更改被确认都有效时，才会应用到实际的文件系统中。

#### Rule

`Rule` 对象定义了一个函数，它接受一个 `Tree` 进行转换，并返回一个新的 `Tree`。

原理图的主文件 `index.ts` 定义了一组实现原理图的规则。我们在运行 `ng add` 时，实际执行的就是 `index.ts` 文件中导出的某个方法。

#### Action

对文件的转换由 `Action`（动作）表示。有四种动作类型：`Create`、`Rename`、` Overwrite` 和 `Delete`。

`Tree` 中也有对应这四个 action 的方法：

```ts
export interface Tree {
  ...
  overwrite(path: string, content: Buffer | string): void;
  create(path: string, content: Buffer | string): void;
  delete(path: string): void;
  rename(from: string, to: string): void;
  readonly actions: Action[];
}
```

#### SchematicContext

每个原理图都在上下文中运行，上下文由一个 `SchematicContext` 表示。
